Date.prototype.formatDate=function(format){var day=this.getDate(),month=this.getMonth()+1,year=this.getFullYear(),hours=this.getHours(),minutes=this.getMinutes(),seconds=this.getSeconds();return-1<(format=(format=format||"MM/dd/yyyy").replace("MM",month.toString().replace(/^(\d)$/,"0$1"))).indexOf("yyyy")?format=format.replace("yyyy",year.toString()):-1<format.indexOf("yy")&&(format=format.replace("yy",year.toString().substr(2,2))),-1<(format=-1<(format=-1<(format=format.replace("dd",day.toString().replace(/^(\d)$/,"0$1"))).indexOf("t")?11<hours?format.replace("t","pm"):format.replace("t","am"):format).indexOf("HH")?format.replace("HH",hours.toString().replace(/^(\d)$/,"0$1")):format).indexOf("hh")&&(12<hours&&(hours-=12),format=format.replace("hh",(hours=0===hours?12:hours).toString().replace(/^(\d)$/,"$1"))),format=-1<(format=-1<format.indexOf("mm")?format.replace("mm",minutes.toString().replace(/^(\d)$/,"0$1")):format).indexOf("ss")?format.replace("ss",seconds.toString().replace(/^(\d)$/,"0$1")):format};var shortCode,dome={},socket=null,defaultHeightOffset="undefined"==typeof specialHeightOffset?50:specialHeightOffset,SOCKET_STATE_ENUM={RECONNECT_FAILED:-1,DISCONNECTED:0,CONNECTED:1,BEFORE_FIRST:2},PREFERENCE_ENUM=(dome.weakBrowser=function(){var chromeVersion=navigator.appVersion.match(/Chrome\/(\d+)/);return null!=chromeVersion&&79<=parseInt(chromeVersion[1])},{cs:{name:"commandSuggestions",storeKey:"commands",def:!0},cw:{name:"channelWindows",storeKey:"channels",def:!(dome.readPreferences=function(){var font,rest,options=window.location.search||null,preferences={commandSuggestions:!0,channelWindows:!1,playDing:!0,localEcho:!1,colorSet:"acid",autoScroll:"dbl",edittheme:"twilight",lineBufferFont:"standard",imagePreview:!1,transparentOverlay:!1,broadSearch:!0,performanceBuffer:dome.weakBrowser()?1750:0};return options&&(-1!=options.indexOf("cs=false")&&(preferences.commandSuggestions=!1),-1!=options.indexOf("cw=true")&&(preferences.channelWindows=!0),-1!=options.indexOf("pd=false")&&(preferences.playDing=!1),-1!=options.indexOf("le=true")&&(preferences.localEcho=!0),-1!=options.indexOf("iv=true")&&(preferences.imagePreview=!0),-1!=options.indexOf("as=long")?preferences.autoScroll="long":-1!=options.indexOf("as=none")&&(preferences.autoScroll="none"),-1!=(ofIndex=options.indexOf("of="))&&(rest=of=options.substr(ofIndex),3<(of=-1!=(n=rest.indexOf("&"))?rest.substr(0,n):of).length)&&(font=of.substr(3),_.contains(FONT_CHOICES,font))&&(preferences.lineBufferFont=font),-1!=(etIndex=options.indexOf("et="))&&(rest=et=options.substr(etIndex),3<(et=-1!=(n=rest.indexOf("&"))?rest.substr(0,n):et).length)&&(font=et.substr(3),_.contains(EDIT_THEMES,font))&&(preferences.edittheme=font),-1!=(clIndex=options.indexOf("cl="))&&(rest=cl=options.substr(clIndex),3<(cl=-1!=(n=rest.indexOf("&"))?rest.substr(0,n):cl).length)&&(font=cl.substr(3),_.contains(COLORSET_CHOICES,font))&&(preferences.colorSet=font),-1!=(pbIndex=options.indexOf("pb="))&&(rest=pb=options.substr(pbIndex),-1!=(n=rest.indexOf("&"))&&(pb=rest.substr(0,n)),0<(pb=parseInt(pb)))&&(preferences.performanceBuffer=pb),-1!=options.indexOf("to=true")&&(preferences.transparentOverlay=!0),-1!=options.indexOf("bs=false"))&&(preferences.broadSearch=!1),preferences})},pd:{name:"playDing",storeKey:"playding",def:!0},le:{name:"localEcho",storeKey:"localecho",def:!1},iv:{name:"imagePreview",storeKey:"imageview",def:!1},as:{name:"autoScroll",storeKey:"scroll",def:"dbl",valid:["dbl","long"]},of:{name:"lineBufferFont",storeKey:"outfont",def:"standard",valid:FONT_CHOICES},et:{name:"edittheme",storeKey:"edittheme",def:"twilight",valid:EDIT_THEMES},cl:{name:"colorSet",storeKey:"colorset",def:"acid",valid:COLORSET_CHOICES},to:{name:"transparentOverlay",storeKey:"transparent",def:!1},bs:{name:"broadSearch",storeKey:"broadly",def:!0},pb:{name:"performanceBuffer",storeKey:"buffer",def:dome.weakBrowser()?1750:0}}),helpDocs=["Help on @client-option:\n","  @client-options\n","  @client-option &lt;option name&gt; [&lt;new value&gt;]\n","\n","  Options Include:\n"];for(shortCode in PREFERENCE_ENUM){var prefName=PREFERENCE_ENUM[shortCode].name;PREFERENCE_ENUM[prefName]=PREFERENCE_ENUM[shortCode],helpDocs[helpDocs.length]="   ["+shortCode+"] "+prefName+"\n"}var CLIENT_OPTION_NAME_ERROR="Unknown @client-option specified, check @client-options\n",CLIENT_OPTION_VALUE_ERROR="Invalid @client-option value, must be one of ",CLIENT_OPTIONS_HELP=helpDocs,showClientOptionHelp=function(){dome.buffer.append(CLIENT_OPTIONS_HELP)},translateClientOptionName=function(optionName){return null!=PREFERENCE_ENUM[optionName]?PREFERENCE_ENUM[optionName].name:optionName},showClientOption=function(optionName){var opts=_.keys(dome.preferences);if(optionName){if(!_.has(dome.preferences,optionName))return dome.buffer.append(CLIENT_OPTION_NAME_ERROR);opts=[optionName]}_.each(opts,function(opt){dome.buffer.append("  "+opt+" : "+dome.preferences[opt]+"\n")})},setClientOption=function(optionName,optionValue){if(!_.has(dome.preferences,optionName))return dome.buffer.append(CLIENT_OPTION_NAME_ERROR);"true"==optionValue?optionValue=!0:"false"==optionValue&&(optionValue=!1);var ac,validValues=PREFERENCE_ENUM[optionName].valid||[!0,!1];if(!_.contains(validValues,optionValue))return dome.buffer.append(CLIENT_OPTION_VALUE_ERROR+validValues.toString()+"\n");clientOptions&&clientOptions.save(PREFERENCE_ENUM[optionName].storeKey,optionValue),dome.preferences[optionName]!=optionValue&&(dome.buffer.append("changing @client-option "+optionName+" to "+optionValue+"\n"),"colorSet"==optionName&&(dome.buffer.removeClass("colorset-"+dome.preferences.colorSet),dome.inputReader.removeClass("colorset-"+dome.preferences.colorSet)),"lineBufferFont"==optionName&&dome.buffer.removeClass(dome.preferences.lineBufferFont+"Text"),"transparentOverlay"==optionName&&null!=(ac=$(".ui-autocomplete"))&&ac.removeClass(dome.preferences.transparentOverlay?"ui-transparent-overlay":"ui-opaque-overlay"),dome.preferences[optionName]=optionValue,"lineBufferFont"==optionName&&dome.buffer.addClass(dome.preferences.lineBufferFont+"Text"),"colorSet"==optionName&&"normal"!=dome.preferences.colorSet&&(dome.buffer.addClass("colorset-"+dome.preferences.colorSet),dome.inputReader.addClass("colorset-"+dome.preferences.colorSet)),"transparentOverlay"==optionName&&null!=(ac=$(".ui-autocomplete"))&&ac.addClass(dome.preferences.transparentOverlay?"ui-transparent-overlay":"ui-opaque-overlay"),"broadSearch"==optionName&&dome.preferences.commandSuggestions&&(dome.inputReader&&dome.inputReader.commandSuggestions("destroy"),dome.autoComplete)&&(dome.autoComplete(),dome.setupAutoComplete(dome.inputReader,dome.userType)),"commandSuggestions"==optionName&&(dome.preferences.commandSuggestions?dome.autoComplete&&(dome.autoComplete(),dome.setupAutoComplete(dome.inputReader,dome.userType)):dome.inputReader&&dome.inputReader.commandSuggestions("destroy")),"localEcho"==optionName&&dome.setEchoButton(dome.preferences.localEcho),"imagePreview"==optionName)&&dome.setImagesButton(dome.preferences.imagePreview)};dome.parseClientOptionCommand=function(command){var optionName;return console.log(command),"@client-options"==command?showClientOption():(command=command.split(" ")).length<2?showClientOptionHelp():(optionName=translateClientOptionName(command[1]),void(command.length<3?showClientOption(optionName):setClientOption(optionName,command[2])))},dome.setupInputReader=function(){$(document).on("keydown",function(e){if(35!=e.keyCode||e.shiftKey||e.altKey||e.ctrlKey){var fast_command,elid;if(36!=e.keyCode||e.shiftKey||e.altKey||e.ctrlKey)return 45!=e.keyCode||e.shiftKey||e.altKey||e.ctrlKey||null!=(fast_command=prompt("Please enter command to send:",""))&&""!=fast_command&&socket.emit("input",fast_command,function(state){dome.preferences.localEcho&&dome.buffer.append('<span class="input-echo">&gt;'+fast_command+"</span>\n"),dome.setFadeText&&dome.statusDisplay&&dome.setFadeText(dome.statusDisplay,state.status&&0==state.status.indexOf("command sent")?"SENT":state.status,!1),fast_command&&0==fast_command.indexOf("@client-option")&&dome.parseClientOptionCommand&&dome.parseClientOptionCommand(fast_command)}),elid=$(document.activeElement).is("input:focus, textarea:focus"),!(8===e.keyCode&&!elid)&&void 0;dome.inputReader.focus()}else dome.onToggleAutoScroll()});var inputReader,lastInput="",commandBuffer=store.get("my-input-buffer")||[],commandPointer=commandBuffer.length||-1;dome.inputReader&&((inputReader=dome.inputReader).on("keydown",function(event){var textarea;return 38==event.which&&0<=commandPointer?((textarea="selectionStart"in(textarea=inputReader[0])?{start:textarea.selectionStart,end:textarea.selectionEnd}:{start:1,end:1}).start==textarea.end&&textarea.start<150&&(commandPointer=(commandPointer<=-1?commandBuffer.length:commandPointer)-1,inputReader.val(commandBuffer[commandPointer]),event.preventDefault()),!1):40==event.which&&commandPointer<commandBuffer.length-1?(commandPointer=(commandPointer+1>commandBuffer.length?0:commandPointer)+1,inputReader.val(commandBuffer[commandPointer]),event.preventDefault(),!1):40==event.which&&commandPointer>=commandBuffer.length-1?(commandPointer=commandBuffer.length,inputReader.val()==lastInput&&""!=inputReader.val()?(commandBuffer[commandBuffer.length]=inputReader.val(),2e3<commandBuffer.length&&commandBuffer.shift(),commandPointer=commandBuffer.length,store.put("my-input-buffer",commandBuffer),inputReader.val(""),lastInput=""):inputReader.val(lastInput),event.preventDefault(),!1):void 0}),inputReader.on("keypress",function(event){if(event.which,13==event.which&&!event.shiftKey){if(dome.autoComplete)try{inputReader.commandSuggestions("close")}catch(e){console.log(e)}event.preventDefault();var command=inputReader.val();return socket.emit("input",command,function(state){dome.preferences.localEcho&&dome.buffer.append('<span class="input-echo">&gt;'+command+"</span>\n"),dome.setFadeText&&dome.statusDisplay&&dome.setFadeText(dome.statusDisplay,state.status&&0==state.status.indexOf("command sent")?"SENT":state.status,!1),command&&0==command.indexOf("@client-option")&&dome.parseClientOptionCommand&&dome.parseClientOptionCommand(command)}),commandBuffer[commandBuffer.length]=inputReader.val(),2e3<commandBuffer.length&&commandBuffer.shift(),commandPointer=commandBuffer.length,store.put("my-input-buffer",commandBuffer),inputReader.val(""),!1}setTimeout(function(){lastInput=inputReader.val()},5)}),inputReader.on("focus",function(){}))},dome.setupWindowHandlers=function(){dome.alert={tone:new Audio("/notice.wav"),pattern:null,active:!1,titleProc:null},dome.urlPatterns={images:/png|jpg|gif|jpeg$/,videos:/mp4|gifv$/,youtube:/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/},dome.parseYouTubeID=function(url){url=url.match(dome.urlPatterns.youtube);return!(!url||11!=url[7].length)&&url[7]};dome.setWindowTitle=function(newTitle){document.title=dome.titleBarText=newTitle};function onResizeHandler(){dome.client.css("height",window.innerHeight+"px"),dome.buffer.css("height",window.innerHeight-defaultHeightOffset+"px")}function alertTitle(){titleAlerted=titleAlerted?(document.title=dome.titleBarText,!1):(document.title="!! "+dome.titleBarText,!0)}var defaultHeightOffset="undefined"==typeof specialHeightOffset?50:specialHeightOffset,titleAlerted=!1,iOS=(dome.windowAlert=function(){null==dome.alert.titleProc&&(dome.alert.titleProc=window.setInterval(alertTitle,500))},!!navigator.userAgent.match(/(iPad|iPhone|iPod)/g)),winJQ=$(window);winJQ.on("focus",function(){dome.alert.active=!1,null!=dome.alert.titleProc&&(window.clearInterval(dome.alert.titleProc),dome.alert.titleProc=null,document.title=dome.titleBarText),dome.inputReader&&dome.inputReader.trigger("focus")}),winJQ.on("blur",function(){dome.preferences.playDing&&(dome.alert.active=!0)}),iOS||winJQ.on("resize",onResizeHandler),winJQ.on("orientationchange",onResizeHandler),winJQ.on("unload",function(){dome.socketState==SOCKET_STATE_ENUM.CONNECTED&&socket.emit("input","@quit\r\n")}),dome.buffer.on("scroll",function(){var shownImages=$(".shown-image",dome.buffer);shownImages&&shownImages.length&&shownImages.each(function(idx,imageElem){var jqElem,win,viewport,imageElem=$(imageElem);jqElem=imageElem,win=$(window),(viewport={top:win.scrollTop(),left:win.scrollLeft()}).right=viewport.left+win.width(),viewport.bottom=viewport.top+win.height(),(win=jqElem.offset()).right=win.left+jqElem.outerWidth(),win.bottom=win.top+jqElem.outerHeight(),(viewport.right<win.left||viewport.left>win.right||viewport.bottom<win.top||viewport.top>win.bottom)&&(jqElem=imageElem.attr("id"),(viewport=$("#b"+jqElem)).removeClass("icon-chevron-down"),viewport.addClass("icon-chevron-up"),$("SPAN#s"+jqElem,dome.buffer).html(""))})}),onResizeHandler()},dome.setupOutputParser=function(){function editorInit(){dome.activeEditor=editor={readingContent:!1,buffer:"",editorName:"",uploadCommand:""}}var whoBox,editor={};editorInit(),dome.parseSocketData=function(segment){var metaCommand,uploadCommand,a,editorName,terminalMarker,ts=new Date,spawned=(editor.readingContent&&(segment=-1!=(terminalMarker=segment.lastIndexOf("\n.\r"))||0==(terminalMarker=segment.indexOf(".\r\n"))?(editor.buffer+=segment.substr(0,terminalMarker),(spawned=dome.makeEditor(editor))&&(dome.spawned[editor.editorName]=spawned,dome.updateEditorListView()),editorInit(),segment.substr(terminalMarker+4)):(editor.buffer+=segment,""),dome.setFadeText)&&dome.statusDisplay&&dome.setFadeText(dome.statusDisplay,'<span class="warn">BUFFERING POPUP ...</span>'),-1);if((0==(spawned=segment.indexOf("#$#"))||0<(spawned=segment.indexOf("\n#$#")))&&(end=segment.indexOf("\r\n",spawned),uploadCommand=(a=(metaCommand=segment.substr(spawned,end-spawned)).split(" upload: "))[a.length-1],editorName=(a=a[0].split(" name: "))[a.length-1],console.log(editorName),"edit"==(metaCommand=a[0].substr(0==spawned?4:5))?(editorInit(),segment=-1!=(terminalMarker=segment.indexOf("\n.\r",end))?(dome.spawned[editorName]=dome.makeEditor({editorName:editorName,uploadCommand:uploadCommand,buffer:segment.substr(end+1,terminalMarker-end)}),dome.updateEditorListView(),segment.substr(0,spawned)+segment.substr(terminalMarker)):(editor.readingContent=!0,editor.buffer+=segment.substr(end+1),editor.editorName=editorName,editor.uploadCommand=uploadCommand,segment.substr(0,spawned))):metaCommand&&0==metaCommand.indexOf("user")?(dome.userType=a[0].substr(a[0].indexOf("user-type"),12).split(" ")[1],segment=segment.substr(0,spawned)+segment.substr(spawned+a[0].length),dome.setupAutoComplete&&dome.inputReader&&dome.setupAutoComplete(dome.inputReader,dome.userType)):"- PING!"==metaCommand?(segment=segment.substr(0,spawned)+segment.substr(spawned+13),dome.setFadeText&&dome.statusDisplay&&dome.setFadeText(dome.statusDisplay,"pinged")):console&&dome.setFadeText&&dome.statusDisplay&&dome.setFadeText(statusDisplay,metaCommand)),dome.channel&&(channelMatches=dome.channel.pattern.exec(segment))&&null!=(channel=dome.channel.getChannel(channelMatches[2])))channel.window?channel.window.onChannelData(segment):(channel=dome.channel.spawnChannel(channelMatches[2]),window.setTimeout(function(){channel.window.onChannelData(segment)},1e3));else{if(_.each(subs,function(sub){segment=segment.replace(sub.pattern,sub.replacement)}),segment=(segment=segment.replace(urlRegex,function(url){var out='<a href="'+(url=0!=url.indexOf("http")?"http://"+url:url)+'" target="_blank">'+url+"</a>",lowerURL=url.toLowerCase(),isImage=lowerURL.match(dome.urlPatterns.images),lowerURL=lowerURL.match(dome.urlPatterns.videos),isYouTube=dome.parseYouTubeID(url);return(isImage||lowerURL||isYouTube)&&(out=out+('<i id="b'+(isImage="i"+(new Date).getTime()+"x"+Math.floor(1e6*Math.random()+1))+'" class="icon-white icon-chevron-'+(dome.preferences.imagePreview?"down":"up"))+'" aria-hidden="true" style="cursor: pointer" onclick="dome.toggleImage(this, \''+isImage+"', '"+url+'\');"></i><span id="s'+isImage+'">',dome.preferences.imagePreview&&(out+='<br><a href="'+url+'" target="_blank">',lowerURL?out=(out+='<video class="shown-image" loop muted autoplay id="'+isImage+'" style="max-width: 75%">')+'<source type="video/mp4" src="'+url.replace(/gifv$/,"mp4")+'"></video>':isYouTube?out=(out=(out=(out=(out+='<iframe id="')+isImage+'" class="shown-image" width="')+(lowerURL=Math.min(dome.buffer.width()-20,560))+'" height="')+Math.floor(.5652*lowerURL)+'" src="https://www.youtube.com/embed/')+isYouTube+'" frameborder="0" allowfullscreen></iframe>':out+='<img class="shown-image" id="'+isImage+'" src="'+url+'" style="max-width: 75%">',out+="</a><br>"),out+="</span>"),out})).replace(ip_regex,'<a href="https://whatismyipaddress.com/ip/$&" target="_new">$&</a>'),(whoBox=void 0===whoBox?$("#who-table"):whoBox).length)if(matches=segment.match(/\[\* SYS\-MSG \*\] ([\w]+)\/([\w]+) \((#[\d]+)\) has (connected|disconnected) [^(]+\(([\d]+)\)/i))if(dome.setFadeText&&dome.statusDisplay&&dome.setFadeText(dome.statusDisplay,matches[1]+"/"+matches[2]+" "+matches[4]),"disconnected"==matches[4]?($("#"+matches[2]+"-who").remove(),$("#how-many-connected").html("There are "+matches[5]+" connected")):"connected"==matches[4]&&(terminalMarker='<tr id="'+matches[2]+'-who"><td><a href="https://www.sindome.org/profile/'+matches[1]+'/" target="_blank"><img border="0" src="///www.sindome.org/bgbb/icon/'+matches[1]+'/pinky/image.png" title="'+matches[1]+'"></a></td><td><a data-who="'+matches[5]+'" href="javascript:void(0);">'+matches[3]+'</a></td><td class="who-name" title="'+matches[1]+" played by "+matches[2]+'"><a href="javascript:void(0);">'+matches[2]+"</a></td><td>0s</td></tr>",$(terminalMarker).insertAfter(".who-header"),$("#how-many-connected").html("There are "+matches[5]+" connected")),dome.preferences.godMode)return;segment=(segment=segment.replace(/(\#\d+\b)/g,'<span class="all-copy">$1</span>')).replace(/(\$\w*)/g,'<span class="all-copy">$1</span>'),dome.alert&&dome.alert.active&&null!=dome.alert.pattern&&segment.match(dome.alert.pattern,"i")&&(dome.alert.tone.play(),dome.windowAlert()),segment=segment.replace(/\n/g,"</div><br/><div>"),dome.buffer.append(segment);var kidCount=dome.buffer.contents().length,end=(new Date).getTime()-ts.getTime();if(1<end&&console.log("slow buffer ... buffer length: "+kidCount+"  | duration: "+end),0<dome.preferences.performanceBuffer)for(;kidCount>dome.preferences.performanceBuffer;)dome.buffer.contents().first().remove(),kidCount=dome.buffer.contents().length;dome.pauseBuffer?(dome.pausedLines++,dome.setFadeText&&dome.statusDisplay&&dome.setFadeText(dome.statusDisplay,dome.pausedLines+" UNREAD LINES")):dome.buffer.animate({scrollTop:dome.buffer[0].scrollHeight},50)}}},dome.setupSocket=function(){function onConnectedHandler(){dome.socketState==SOCKET_STATE_ENUM.DISCONNECTED&&(dome.disconnectView.overlay.addClass("hide"),dome.disconnectView.buttonGroup.addClass("hide")),dome.socketState=SOCKET_STATE_ENUM.CONNECTED,dome.inputReader&&dome.inputReader[0].focus(),dome.setFadeText&&dome.statusDisplay&&dome.setFadeText(dome.statusDisplay,"CONNECTED"),initialCommand||setTimeout(function(){var cmd,who;(cmd=store.get("dc-initial-command"))?(dome.setWindowTitle&&dome.setWindowTitle("Guest | "+gameName+" | "+poweredBy),dome.socket.emit("input",cmd,function(){store.remove("dc-initial-command")})):(cmd=store.get("dc-user-login"))&&(who=store.get("last-username"),dome.alert.pattern=new RegExp(who),dome.setWindowTitle&&dome.setWindowTitle(who+" | "+gameName+" | "+poweredBy),dome.socket.emit("input",cmd,function(){})),dome.preferences.shortenUrls&&dome.socket.emit("shorten-on","shorten-on",function(){console&&console.log("enabling short urls")})},2e3),initialCommand=!0}var initialCommand=!1;return(socket=io.connect("https:"==document.location.protocol?socketUrlSSL:socketUrl,{query:"host="+dome.gameHostname+"&port="+dome.gamePort,"sync disconnect on unload":!0})).on("connected",function(data){onConnectedHandler()}),socket.on("disconnected",function(data){console.log("disconnected"),dome.socketState!=SOCKET_STATE_ENUM.CONNECTED&&console.log("disconnected before we connected!"),dome.socketState=SOCKET_STATE_ENUM.DISCONNECTED,dome.activeEditor&&(dome.activeEditor.readingContent=!1),dome.setFadeText&&dome.statusDisplay&&dome.setFadeText(dome.statusDisplay,"DISCONNECTED",!0),dome.disconnectView.overlay.removeClass("hide"),dome.disconnectView.buttonGroup.removeClass("hide")}),socket.on("reconnect_failed",function(data){dome.socketState=SOCKET_STATE_ENUM.RECONNECT_FAILED,dome.disconnectView.overlay.removeClass("hide"),dome.disconnectView.buttonGroup.removeClass("hide")}),socket.on("error",function(e){dome.onErrorHandler&&dome.onErrorHandler(e)}),socket},dome.setupEditorSupport=function(){window.getSocket=function(){return dome.socket},dome.makeEditor=function(editor){var type,editWindow=null;return _.has(dome.spawned,editor.editorName)&&null!=dome.spawned[editor.editorName]&&((editWindow=dome.spawned[editor.editorName]).focus(),!editWindow.confirm("Replace existing editor of the same name? You may have active edits."))?null:(type="basic-readonly",editor.uploadCommand&&(type=-1!=editor.uploadCommand.indexOf("@program")?"verb":"basic"),editor.type&&(type=editor.type),editor.buffer=editor.buffer.replace(/^\n/,"").replace(/[\r\n]+$/,""),type="/editor/"+type+"/?et="+dome.preferences.edittheme+"&ts="+(new Date).getTime(),null!=editWindow&&_.has(editWindow,"updateEditor")?editWindow.updateEditor(editor.buffer):editWindow=window.open(type,""+editor.editorName,"width=640,height=480,resizeable,scrollbars"),editWindow.editorData=editor,editWindow.uploadSocket=socket,editWindow.parentWindow=window,editWindow.focus(),editWindow)},dome.updateEditorListView=function(){var v=dome.editorListView;if(null==v)console.log("no editor list view");else if(v.hide(),v.html(""),!_.isEmpty(dome.spawned)){var title,listHTML="<ul>";for(title in dome.spawned)dome.spawned.hasOwnProperty(title)&&null!=dome.spawned[title]&&(listHTML=(listHTML=listHTML+'<li data-editor="'+title+'"><span data-editor="'+title+'" class="truncate" title="'+title+'">'+title+"</span>")+'<a data-editor="'+title+'" title="close editor" href="javascript:void(0);"><i data-editor="'+title+'" class="glyph-button-close"></i></a></li>');v.html(listHTML+="</ul>"),v.show()}};null!=dome.editorListView&&dome.editorListView.on("click",function(e){e.currentTarget&&((editorName,action)=>{console.log(editorName,action,dome.spawned[editorName]),null!=dome.spawned[editorName]&&(dome.spawned[editorName].focus(),"close"==action)&&(dome.spawned[editorName].close(),delete dome.spawned[editorName]),dome.updateEditorListView()})($(e.target).data("editor"),"I"!=e.target.tagName&&"A"!=e.target.tagName?"zoom":"close")}),dome.editorClosed=function(editorName){_.has(dome.spawned,editorName)&&(delete dome.spawned[editorName],dome.updateEditorListView())}},dome.setupAutoscroll=function(){dome.pauseBuffer=!1,dome.pausedLines=0;var longClickProc=null;dome.onToggleAutoScroll=function(event){longClickProc=null,window.getSelection().removeAllRanges();var button=dome.scrollButton;(dome.pauseBuffer?(dome.pauseBuffer=!1,dome.pausedLines=0,dome.setFadeText&&dome.setFadeText(dome.statusDisplay,"SCROLLING RESUMED"),dome.buffer.animate({scrollTop:dome.buffer[0].scrollHeight},50),dome.buffer.removeClass("scroll-disabled"),button.html('<i class="icon-pause icon-white" aria-hidden="true"></i><span class="hidden-xs">PAUSE SCROLL</span>'),button.addClass("btn-primary"),button.removeClass("btn-danger"),$("#inputBuffer")):(dome.pauseBuffer=!0,dome.setFadeText&&dome.setFadeText(dome.statusDisplay,"SCROLLING PAUSED"),dome.buffer.addClass("scroll-disabled"),button.html('<i class="icon-play icon-white" aria-hidden="true"></i><span class="hidden-xs">RESUME SCROLL</span>'),button.addClass("btn-danger"),button.removeClass("btn-primary"),$("#lineBuffer"))).trigger("focus")},"dbl"==dome.preferences.autoScroll?dome.buffer.on("dblclick",dome.onToggleAutoScroll):"long"==dome.preferences.autoScroll?(dome.buffer.on("mousedown",function(event){longClickProc=window.setTimeout(dome.onToggleAutoScroll,2e3)}),dome.buffer.on("mouseup",function(event){null!=longClickProc&&window.clearTimeout(longClickProc),longClickProc=null})):dome.preferences.autoScroll},dome.setupButtons=function(){dome.setImagesButton=function(showImages){dome.imagesButton&&(dome.imagesButton.html(showImages?'<i class="icon-eye-close icon-white" aria-hidden="true"></i><span class="hidden-xs">NO IMAGES</span>':'<i class="icon-eye-open icon-white" aria-hidden="true"></i><span class="hidden-xs">IMAGES</span>'),showImages||$("I.icon-chevron-down",dome.buffer).trigger("click"))},dome.imagesButton&&dome.imagesButton.on("click",function(){dome.preferences.imagePreview=!dome.preferences.imagePreview,dome.setImagesButton(dome.preferences.imagePreview)}),dome.setEchoButton=function(showEcho){dome.echoButton&&dome.echoButton.html(showEcho?'<i class="icon-volume-off icon-white" aria-hidden="true"></i><span class="hidden-xs">HIDE ECHO</span>':'<i class="icon-volume-up icon-white" aria-hidden="true"></i><span class="hidden-xs">ECHO</span>')},dome.echoButton&&dome.echoButton.on("click",function(){dome.preferences.localEcho=!dome.preferences.localEcho,dome.setEchoButton(dome.preferences.localEcho)}),dome.reconnectButton&&dome.reconnectButton.on("click",function(){window.location.reload()}),dome.saveButton&&dome.saveButton.on("click",function(){var now=new Date,now=""+(now.getMonth()+1)+now.getDate()+now.getFullYear()+now.getHours()+now.getMinutes(),form=$("#save-form");form.attr("action","/save/buffer."+now+".html"),$("input",form).val(dome.buffer.html()),form.submit()}),dome.clearButton&&dome.clearButton.on("click",function(){dome.buffer.html("")}),dome.scrollButton&&dome.onToggleAutoScroll&&dome.scrollButton.on("click",dome.onToggleAutoScroll),dome.closeAllButton&&dome.closeAllButton.on("click",function(){if(dome.spawned)for(var i=0;i<dome.spawned.length;i++)dome.spawned[i]&&dome.spawned[i].close();if(dome.channels)for(i=0;i<dome.channels.length;i++)dome.channels[i].window&&dome.channels[i].window.close();window.close()}),dome.attachImage=function(jqElem,imageId,url){var isVideo=url.toLowerCase().match(/mp4|gifv$/),isYouTube=dome.parseYouTubeID(url),segment='<br><a href="'+url+'" target="_blank">';isVideo?segment=(segment+='<video id="'+imageId+'" loop muted autoplay class="shown-image" style="max-width: 75%">')+'<source type="video/mp4" src="'+url.replace(/gifv$/,"mp4")+'"></video>':isYouTube?segment=(segment=(segment=(segment=(segment+='<iframe id="')+imageId+'" class="shown-image" width="')+(isVideo=Math.min(dome.buffer.width()-20,560))+'" height="')+Math.floor(.5652*isVideo)+'" src="https://www.youtube.com/embed/')+isYouTube+'" frameborder="0" allowfullscreen></iframe>':segment+='<img class="shown-image" id="'+imageId+'" src="'+url+'" style="max-width: 75%">',jqElem.html(segment+="</a><br>")},dome.toggleImage=function(elem,imageId,imageURL){var elem=$(elem),span=$("SPAN#s"+imageId,dome.buffer);elem.length&&span.length?elem.hasClass("icon-chevron-down")?(elem.removeClass("icon-chevron-down"),elem.addClass("icon-chevron-up"),span.html("")):(elem.removeClass("icon-chevron-up"),elem.addClass("icon-chevron-down"),dome.attachImage(span,imageId,imageURL)):console.log(elem,span,imageId)}},$.widget("custom.commandSuggestions",$.ui.autocomplete,{_renderItem:function(ul,item){return $("<li>").data("item.autocomplete",item).data("custom-commandSuggestions",item).attr("data-value",item.value).addClass("ui-menu-item").append(item.display).appendTo(ul)},_resizeMenu:function(){var bestWidth=Math.min(dome.buffer.width()-20,800);this.menu.element.outerWidth(bestWidth)}}),dome.autoCommands=[],dome.autoComplete=function(){function prettyCommandArguments(unformattedString){return _.reduce(unformattedString.match(commandArgumentPattern),function(out,commandArg){return out.replace(commandArg,"<i>&lt;"+commandArg.substring(1,commandArg.length-1)+"&gt;</i>")},unformattedString)}var commandArgumentPattern=new RegExp(/<[-A-Z a-z]+>/,"g");dome.autoCommands=[],dome.setupAutoComplete=function(inputBuffer,userType){null==inputBuffer||window.location.query&&-1!=window.location.query.indexOf("ac=no")||(0<dome.autoCommands.length&&inputBuffer.commandSuggestions("destroy"),$.ajax({url:"/ac/"+userType,dataType:"json",success:function(data){dome.autoCommands=_.reduce(data,function(out,line){var commandParts,commandSyntax,line=line.trim(),commandSearch=line,commandHelp='<div class="command-syntax">'+line+"</div>",parts=line.split("|");return 1<parts.length&&(commandSyntax=commandSearch=line=parts[0].trim(),1<(commandParts=line.split(" ")).length&&(line=commandParts[0]),commandHelp='<div class="command-syntax">'+prettyCommandArguments(commandSyntax)+"</div>",commandParts=parts[1].trim(),dome.preferences.broadSearch&&(commandSearch+=commandParts),commandHelp+='<div class="command-instruction">'+prettyCommandArguments(commandParts)+"</div>",2<parts.length)&&""!=parts[2]&&(commandSyntax=parts[2].trim(),dome.preferences.broadSearch&&(commandSearch+=commandSyntax),commandHelp+='<div class="command-requires">'+commandSyntax+"</div>"),out[out.length]={label:commandSearch,display:"<a>"+commandHelp+"</a>",value:line},out},[]),inputBuffer.commandSuggestions({delay:0,minLength:2,position:{my:"left bottom",at:"left bottom",of:"DIV#lineBuffer",offset:"10 -20"},source:function(req,next){for(var term=new RegExp((2==req.term.length?"^":"")+req.term),matches=[],i=0;i<dome.autoCommands.length;i++){var item=dome.autoCommands[i];term.test(item.label)&&matches.push(item)}next(matches)},classes:{"ui-autocomplete":dome.transparentOverlay?"ui-transparent-overlay":"ui-solid-overlay"}})}}))}},$(document).ready(function(){(dome=_.extend(dome,{userType:"p",socket:null,socketState:SOCKET_STATE_ENUM.BEFORE_FIRST,titleBarText:null,gameHealth:[],client:$("#browser-client"),buffer:$("#lineBuffer"),healthDisplay:$("#gameHealth"),healthDetail:$("#gameHealthDetail"),statusDisplay:$("#statusMsg"),editorListView:$("#editor-list-view"),inputReader:$("#inputBuffer"),reconnectButton:$("#button-reconnect"),saveButton:$("#button-save, #button-save-mini"),scrollButton:$("#button-auto-scroll"),clearButton:$("#button-clear-buffer"),echoButton:$("#button-local-echo"),imagesButton:$("#button-view-images"),closeAllButton:$("#button-closeall"),perfBufferFlag:$("#perf-buffer-flag"),disconnectView:{overlay:$("#disconnect-overlay"),buttonGroup:$(".disconnect-buttons")},spawned:{},channels:[],makeEditor:null,channel:null,refreshRecent:function(e){e.preventDefault()}})).preferences=dome.readPreferences(),"standard"!=dome.preferences.lineBufferFont&&dome.buffer.removeClass("standardText").addClass(dome.preferences.lineBufferFont+"Text"),"normal"!=dome.preferences.colorSet&&dome.buffer.addClass("colorset-"+dome.preferences.colorSet),dome.setupChannels&&dome.setupChannels(),dome.inputReader&&(dome.setupInputReader&&dome.setupInputReader(),dome.preferences.commandSuggestions)&&null!=dome.autoComplete&&(dome.autoComplete(),dome.setupAutoComplete(dome.inputReader,dome.userType)),dome.setupWindowHandlers&&dome.setupWindowHandlers(),dome.setupEditorSupport&&dome.setupEditorSupport(),dome.setupAutoscroll&&dome.setupAutoscroll(),dome.setupButtons&&dome.setupButtons(),dome.setupHealthCheck&&dome.setupHealthCheck(),dome.setupOutputParser(),setTimeout(function(){dome.socket=dome.setupSocket(),dome.socket.on("data",dome.parseSocketData)},500)});